# Markdown Configuration Changes

This document tracks all custom Markdown configuration settings and their rationale, to help with troubleshooting and potential rollback.

## Current Configuration

**File:** `eleventy.config.js`  
**Location:** Lines 15-17

```javascript
const md = new MarkdownIt({
	html: true, // Enable HTML tags in source
	breaks: true, // Convert \n in paragraphs into <br> for poetry
});
```

**Additional setup:**  
Line 329: `eleventyConfig.setLibrary("md", md);`

This tells Eleventy to use our custom MarkdownIt instance instead of its default one.

---

## Change History

### Change 1: Enable `breaks: true` (2026-01-04)

**Problem:** Poetry in blockquotes was rendering on a single line instead of preserving line breaks.

**Example:**
```markdown
> Line one
> Line two
> Line three
```

Was rendering as: `Line one Line two Line three`

**Solution:** Added `breaks: true` to MarkdownIt configuration.

**Effect:** Single line breaks (`\n`) in markdown are now converted to `<br>` tags in HTML. This means:
- Poetry preserves line breaks without needing two spaces at end of line or blank lines between
- Any single line break in regular text will also create a `<br>` tag
- Multi-paragraph content still requires blank lines between paragraphs

**Commit/Date:** 2026-01-04

**Original Configuration:**
```javascript
const md = new MarkdownIt();
```

**Modified Configuration:**
```javascript
const md = new MarkdownIt({
	breaks: true,
});
```

---

### Change 2: Enable `html: true` (2026-01-04)

**Problem:** After enabling `breaks: true`, HTML generated by shortcodes (specifically `{% fn %}` footnotes) was being escaped and displayed as literal text instead of rendering as HTML.

**Symptoms:**
- Footnote shortcode output showed as `&lt;sup class=&quot;fn-ref&quot;&gt;...` instead of actual HTML
- All content following the footnote shortcode was displaying as escaped HTML
- The page essentially broke after the first footnote

**Root Cause:** By default, MarkdownIt escapes HTML in the source. When `breaks: true` is enabled and shortcodes return multi-line HTML, MarkdownIt treats the HTML output as user content and escapes it for safety.

**Solution:** Added `html: true` to MarkdownIt configuration.

**Effect:** HTML tags in the markdown source (and from shortcodes) are now passed through without escaping. This means:
- Shortcodes that return HTML work correctly
- You can write raw HTML in markdown files and it will render
- **Security consideration:** Be cautious about user-generated content if this site ever accepts external input

**Commit/Date:** 2026-01-04

**Modified Configuration:**
```javascript
const md = new MarkdownIt({
	html: true,
	breaks: true,
});
```

---

### Change 3: Set custom library with `setLibrary()` (2026-01-04)

**Problem:** The custom MarkdownIt instance (`md`) was being used in shortcodes but not for processing main markdown files. This caused inconsistent behavior.

**Symptoms:**
- First poem in "babble-and-cant" didn't have line breaks (no `<br>` tags)
- Second poem in same file DID have line breaks
- The difference: content in shortcodes used the custom `md` instance, but main content used Eleventy's default

**Solution:** Added `eleventyConfig.setLibrary("md", md);` to tell Eleventy to use our custom instance everywhere.

**Effect:** All markdown processing (main content, shortcodes, filters) now uses the same configured MarkdownIt instance with consistent settings.

**Commit/Date:** 2026-01-04

---

## Potential Issues & Monitoring

### Watch for:

1. **Unwanted line breaks in prose:**
   - If you have line breaks in your source markdown for readability (e.g., wrapping long paragraphs), these will now render as `<br>` tags
   - **Workaround:** Don't hard-wrap prose paragraphs in source files
   - **Alternative:** Write prose in continuous lines without manual line breaks

2. **HTML injection concerns:**
   - With `html: true`, any HTML in markdown files will render
   - This is fine for a personal blog where you control all content
   - **Risk:** If you ever add user comments or external content, sanitize it first

3. **Rendering differences in existing posts:**
   - Posts written before this change may render differently
   - Check especially:
     - Long prose paragraphs with manual line wrapping
     - Content with intentional HTML entities
     - Lists and other structured content with specific spacing

4. **Shortcode behavior:**
   - Shortcodes that return multi-line HTML now work correctly
   - If you create new shortcodes, remember they must return valid HTML
   - The HTML they generate will be passed through without escaping

### Testing checklist after changes:

- [ ] Check poetry/verse formatting (blockquotes with line breaks)
- [ ] Verify footnote shortcodes (`{% fn %}`) render correctly
- [ ] Verify margin note shortcodes (`{% mn %}`) still work
- [ ] Check figure shortcodes (`{% figure %}`) with multi-line captions
- [ ] Review several existing posts for unintended formatting changes
- [ ] Test build process completes without errors

---

## Rollback Instructions

### To disable line breaks in poetry:

**File:** `eleventy.config.js`, lines 15-17

Change:
```javascript
const md = new MarkdownIt({
	html: true,
	breaks: true, // ← Remove or set to false
});
```

To:
```javascript
const md = new MarkdownIt({
	html: true,
	breaks: false,
});
```

**Alternative workaround:** Use two spaces at the end of each poetry line, or use preformatted text blocks.

---

### To disable HTML passthrough:

**File:** `eleventy.config.js`, lines 15-17

Change:
```javascript
const md = new MarkdownIt({
	html: true, // ← Remove or set to false
	breaks: true,
});
```

To:
```javascript
const md = new MarkdownIt({
	html: false,
	breaks: true,
});
```

**Warning:** This will break the `{% fn %}` shortcode (and possibly others). You would need to refactor shortcodes to avoid returning multi-line HTML, or find another solution.

---

### To revert to completely default Markdown:

**File:** `eleventy.config.js`

1. Change line 15 to:
```javascript
const md = new MarkdownIt();
```

2. Remove or comment out line 329:
```javascript
// eleventyConfig.setLibrary("md", md);
```

**Effect:** Reverts to Eleventy's default Markdown processing. Poetry line breaks will not work, and shortcodes may need adjustment.

---

## MarkdownIt Options Reference

For future reference, here are other MarkdownIt options that might be useful:

```javascript
const md = new MarkdownIt({
	html: true,           // Enable HTML tags in source
	xhtmlOut: false,      // Use '/' to close single tags (<br />)
	breaks: true,         // Convert '\n' in paragraphs into <br>
	langPrefix: 'language-', // CSS language prefix for fenced blocks
	linkify: false,       // Autoconvert URL-like text to links
	typographer: false,   // Enable smartquotes and other replacements
	quotes: '""''',       // Quote characters for smartquotes
});
```

**Current active options:**
- `html: true` - Required for shortcodes to work
- `breaks: true` - Required for poetry line breaks

All other options are at their defaults.

---

## Related Files

- **Main config:** `/eleventy.config.js`
- **Shortcodes documentation:** `/SHORTCODES.md`
- **Posts using poetry formatting:**
  - `/content/blog/babble-and-cant-and-flummery/index.md`
  - `/content/blog/a-failure-as-a-mouser-a-failure-as-a-cat/index.md`
  - (Check other posts with blockquoted poems)

---

## Additional Notes

### Why not use `<pre>` or `<code>` for poetry?

- Semantic HTML: `<blockquote>` is semantically correct for quoted poetry
- Styling: Easier to style with web fonts and maintain consistent typography
- Accessibility: Screen readers handle blockquotes better than preformatted text for literary content
- Flexibility: Can include inline formatting (italics, links, etc.) in poetry lines

### Alternative approaches considered:

1. **Two-space line breaks:** Standard Markdown allows two spaces at end of line to create `<br>`. Rejected because it's invisible in source and easy to forget.

2. **Manual `<br>` tags:** Could write `<br>` explicitly in markdown. Rejected because it's verbose and breaks the reading flow in source files.

3. **Custom poem shortcode:** Could create `{% poem %}` shortcode (see TODO list). Future enhancement that would wrap this functionality more semantically.

4. **CSS-only solution:** Could use `white-space: pre-line` in CSS. Rejected because it doesn't work reliably in blockquotes without affecting other content.

---

**Document created:** 2026-01-04  
**Last updated:** 2026-01-04  
**Author:** Claude (at user's request for rollback documentation)
