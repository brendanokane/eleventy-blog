{% set pageUrl = page.url or "/" %}
{% set isEmailPage = pageUrl | slice(0, 8) == "/emails/" %}
<!doctype html>
<html lang="{{ metadata.language }}"{% if isEmailPage %} data-pagefind-ignore="all"{% endif %}>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		{# SEO/OG metadata #}
		{% set siteUrl = (metadata.url or "") | trim %}
		{% if siteUrl and siteUrl | slice(-1) == "/" %}
			{% set siteUrl = siteUrl | slice(0, -1) %}
		{% endif %}
		{% set absPageUrl = siteUrl + pageUrl if siteUrl else pageUrl %}
		{% set canonicalUrl = canonical_url or absPageUrl %}

		{% set pageTitle = title or metadata.title %}
		{% set pageDescription = description or metadata.description %}

		{% set ogTitle = og_title or pageTitle %}
		{% set ogDescription = og_description or pageDescription %}
		{% set ogImage = og_image or (metadata.og and metadata.og.defaultImage) %}
		{% if ogImage %}
			{% set ogImageAbs = ogImage if "http" in ogImage else siteUrl + ogImage %}
		{% endif %}

		<title>{{ pageTitle }}</title>
		<meta name="description" content="{{ pageDescription }}">
		<link rel="canonical" href="{{ canonicalUrl }}">

		{# OpenGraph #}
		<meta property="og:site_name" content="{{ metadata.title }}">
		<meta property="og:type" content="article">
		<meta property="og:title" content="{{ ogTitle }}">
		<meta property="og:description" content="{{ ogDescription }}">
		<meta property="og:url" content="{{ canonicalUrl }}">
		{% if ogImageAbs %}
		<meta property="og:image" content="{{ ogImageAbs }}">
		{% endif %}

		{# Twitter Card #}
		<meta name="twitter:card" content="{{ 'summary_large_image' if ogImageAbs else 'summary' }}">
		<meta name="twitter:title" content="{{ ogTitle }}">
		<meta name="twitter:description" content="{{ ogDescription }}">
		{% if ogImageAbs %}
		<meta name="twitter:image" content="{{ ogImageAbs }}">
		{% endif %}

		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="{{ metadata.title }}">

		{# Favicons #}
		<link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
		<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">

		{# CSS - inlined #}
		<style eleventy:ignore>{% include "css/index.css" %}</style>

		{# Web Fonts #}
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@400;600;700&family=Vollkorn:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
	</head>

	<body{% if isEmailPage %} data-pagefind-ignore="all"{% endif %}>
		<a href="#main" class="visually-hidden">Skip to main content</a>

		<div class="site-header-container">
			<header class="site-header">
				<a href="/" class="home-link">
					<img class="site-logo" src="/img/burning-house-logo.svg" alt="" aria-hidden="true">
					<span>{{ metadata.title }}</span>
				</a>
				<nav>
					<ul class="nav">
						<li><a href="/"{% if page.url == "/" %} aria-current="page"{% endif %}>Home</a></li>
						<li><a href="/blog/"{% if page.url == "/blog/" %} aria-current="page"{% endif %}>Archive</a></li>
						<li><a href="/about/"{% if page.url == "/about/" %} aria-current="page"{% endif %}>About</a></li>
					</ul>
				</nav>
			</header>
		</div>

		<main id="main" class="main-content-container">
			<div class="layout-container">
				{{ content | safe }}
			</div>
		</main>

		<div class="site-footer-container">
			<footer class="site-footer">
				<p><em>Built with <a href="https://www.11ty.dev/">{{ eleventy.generator }}</a></em></p>
			</footer>
		</div>

		{# Accessible margin notes JS - keyboard support, focus management, responsive ARIA #}
		<script eleventy:ignore>
		(function() {
			var MOBILE_BREAKPOINT = 1024; // Match CSS breakpoint
			var wasMobile = window.innerWidth < MOBILE_BREAKPOINT;

			// Handle both click and keyboard activation
			function handleTriggerActivation(e) {
				// For keyboard events, only respond to Enter or Space
				if (e.type === 'keydown' && !(e.key === 'Enter' || e.key === ' ')) {
					return;
				}

				if (e.type === 'keydown') {
					e.preventDefault(); // Prevent space from scrolling page
				}

				var trigger = e.target.closest('.mn-marker, .fn-marker, .fn-anchor');
				if (!trigger) return;

				// Only toggle on mobile
				if (window.innerWidth >= MOBILE_BREAKPOINT) return;

				var ref = trigger.closest('.mn-ref, .fn-ref');
				if (!ref) return;

				var note = ref.querySelector('.mn-note');
				if (!note) return;

				e.preventDefault();

				// Toggle visibility
				var isExpanded = !note.classList.contains('is-visible');
				note.classList.toggle('is-visible');
				trigger.setAttribute('aria-expanded', isExpanded);

				// Focus management
				if (isExpanded) {
					manageFocusForExpandedNote(note, trigger);
				}
			}

			// Move focus to note content when expanded
			function manageFocusForExpandedNote(note, trigger) {
				// Make note temporarily focusable
				note.setAttribute('tabindex', '-1');
				note.focus();

				// Remove tabindex on blur so it doesn't stay in tab order
				note.addEventListener('blur', function removeTempTabindex() {
					note.removeAttribute('tabindex');
					note.removeEventListener('blur', removeTempTabindex);
				}, { once: true });

				// Announce expansion to screen readers
				var announcement = document.createElement('div');
				announcement.setAttribute('role', 'status');
				announcement.setAttribute('aria-live', 'polite');
				announcement.className = 'visually-hidden';
				announcement.textContent = 'Note ' + trigger.textContent.trim() + ' expanded';
				document.body.appendChild(announcement);

				// Remove announcement after it's been read
				setTimeout(function() {
					if (announcement.parentNode) {
						announcement.remove();
					}
				}, 1000);
			}

			// Register event listeners
			document.addEventListener('click', handleTriggerActivation);
			document.addEventListener('keydown', handleTriggerActivation);

			// Desktop: position notes to align with their anchors
			function positionNotes() {
				// Position margin notes
				document.querySelectorAll('.post-body .mn-ref').forEach(function(ref) {
					var note = ref.querySelector('.mn-note');
					var anchor = ref.querySelector('.mn-anchor-text, .mn-marker');
					if (!note || !anchor) return;

					var anchorRect = anchor.getBoundingClientRect();
					var postBody = ref.closest('.post-body');
					if(!postBody) return;

					var bodyRect = postBody.getBoundingClientRect();
					var offset = anchorRect.top - bodyRect.top;

					note.style.top = offset + 'px';
				});

				// Position figure captions in margin
				document.querySelectorAll('figure.fig-margin').forEach(function(fig) {
					var img = fig.querySelector('img');
					var caption = fig.querySelector('.fig-caption-margin');
					if(!img || !caption) return;

					var imgRect = img.getBoundingClientRect();
					var figRect = fig.getBoundingClientRect();
					var offset = imgRect.top - figRect.top;
					caption.style.top = offset + 'px';
				});
			}

			// Clean up mobile state when transitioning to desktop
			function clearMobileState() {
				document.querySelectorAll('.mn-note.is-visible').forEach(function(note) {
					note.classList.remove('is-visible');
					note.removeAttribute('tabindex'); // Clean up focus management
				});
				document.querySelectorAll('[aria-expanded="true"]').forEach(function(el) {
					el.setAttribute('aria-expanded', 'false');
				});
			}

			// Update ARIA attributes based on viewport
			function updateAriaAttributes() {
				var isMobile = window.innerWidth < MOBILE_BREAKPOINT;

				document.querySelectorAll('.mn-ref').forEach(function(ref) {
					var trigger = ref.querySelector('.mn-marker');
					var note = ref.querySelector('.mn-note');

					if (!trigger || !note) return;

					if (isMobile) {
						// Mobile: enable disclosure widget pattern
						var isVisible = note.classList.contains('is-visible');
						trigger.setAttribute('aria-expanded', isVisible ? 'true' : 'false');
						trigger.setAttribute('aria-controls', note.id);
					} else {
						// Desktop: notes always visible, remove disclosure pattern
						trigger.removeAttribute('aria-expanded');
						trigger.removeAttribute('aria-controls');
						// Note: Keep aria-label for context
					}
				});
			}

			function handleLayout() {
				var isMobile = window.innerWidth < MOBILE_BREAKPOINT;

				// Clean up state when transitioning from mobile to desktop
				if (wasMobile && !isMobile) {
					clearMobileState();
				}

				// Update ARIA attributes based on viewport
				updateAriaAttributes();

				// Position notes on desktop
				if (!isMobile) {
					positionNotes();
				}

				wasMobile = isMobile;
			}

			// Debounced resize handler
			var resizeTimeout;
			function onResize() {
				clearTimeout(resizeTimeout);
				resizeTimeout = setTimeout(handleLayout, 100);
			}

			function init() {
				handleLayout();
				window.addEventListener('resize', onResize);

				// Re-run after fonts load (fixes initial positioning)
				if (document.fonts && document.fonts.ready) {
					document.fonts.ready.then(handleLayout);
				}

				// Re-run on window load as a fallback for images, etc.
				window.addEventListener('load', handleLayout);
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', init);
			} else {
				init();
			}
		})();
		</script>
	</body>
</html>
