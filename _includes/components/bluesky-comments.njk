{#
  Bluesky Comments Component (Hybrid Cached)

  Strategy:
  - Server-renders comments at build time (cached, fast, SEO-friendly)
  - Client-side checks for new comments and shows "New" badge
  - Falls back gracefully if Bluesky API is down
  - You own the comment archive

  Usage: {% include "components/bluesky-comments.njk" %}

  Requires: bluesky_thread variable in context
#}

{% if bluesky_thread %}
<section class="bluesky-comments" id="comments" data-pagefind-ignore>
  {% set comments = bluesky_thread | getBlueskyComments %}

  <h2 class="comments-heading">Discussion{% if comments.length > 0 %} ({{ comments.length }}){% endif %}</h2>

  {% if comments.length > 0 %}
  <div class="comments-list" data-thread="{{ bluesky_thread }}">
    {% for comment in comments %}
    <article class="comment"
             data-depth="{{ comment.depth }}"
             data-timestamp="{{ comment.timestamp }}"
             style="--comment-depth: {{ comment.depth }};">
      <header class="comment-header">
        <a href="https://bsky.app/profile/{{ comment.author.handle }}"
           class="comment-author-link"
           target="_blank"
           rel="noopener noreferrer">
          <img src="{{ comment.author.avatar }}"
               alt=""
               class="comment-avatar"
               width="48"
               height="48"
               loading="lazy">
          <div class="comment-author">
            <strong class="comment-author-name">{{ comment.author.displayName }}</strong>
            <span class="comment-author-handle">@{{ comment.author.handle }}</span>
          </div>
        </a>
        <a href="{{ comment.url }}"
           class="comment-timestamp"
           target="_blank"
           rel="noopener noreferrer"
           title="{{ comment.timestamp }}">
          <time datetime="{{ comment.timestamp }}">{{ comment.relativeTime }}</time>
        </a>
      </header>

      <div class="comment-body">
        <p class="comment-text">{{ comment.text }}</p>
      </div>

      <footer class="comment-footer">
        <div class="comment-stats">
          {% if comment.likeCount > 0 %}
            <span class="stat stat-likes">
              <span class="stat-icon">‚ù§Ô∏è</span>
              <span class="stat-count">{{ comment.likeCount }}</span>
            </span>
          {% endif %}
          {% if comment.replyCount > 0 %}
            <span class="stat stat-replies">
              <span class="stat-icon">üí¨</span>
              <span class="stat-count">{{ comment.replyCount }}</span>
            </span>
          {% endif %}
          {% if comment.repostCount > 0 %}
            <span class="stat stat-reposts">
              <span class="stat-icon">üîÑ</span>
              <span class="stat-count">{{ comment.repostCount }}</span>
            </span>
          {% endif %}
        </div>
        <a href="{{ comment.url }}" class="comment-reply-link" target="_blank" rel="noopener noreferrer">Reply</a>
      </footer>
    </article>
    {% endfor %}
  </div>
  {% endif %}

  <p class="comments-cta">
    <a href="{{ bluesky_thread }}" class="join-discussion" target="_blank" rel="noopener noreferrer">
      Join the conversation on Bluesky ‚Üí
    </a>
  </p>

  {# Client-side: Check for new comments and mark them #}
  <script type="module" eleventy:ignore>
    const BLUESKY_API = 'https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread';
    const commentsList = document.querySelector('.comments-list[data-thread]');
    const threadUrl = commentsList?.dataset.thread;

    if (threadUrl && commentsList) {
      checkForNewComments();
    }

    function extractPostUri(url) {
      const match = url.match(/bsky\.app\/profile\/([^\/]+)\/post\/([^\/\?#]+)/);
      if (!match) return null;
      const [, handle, postId] = match;
      return `at://${handle}/app.bsky.feed.post/${postId}`;
    }

    function parseComments(thread) {
      if (!thread?.thread?.replies) return [];
      const comments = [];

      function traverse(reply, depth = 0) {
        if (!reply?.post) return;
        const post = reply.post;

        comments.push({
          timestamp: post.record?.createdAt,
          author: {
            handle: post.author.handle,
            displayName: post.author.displayName || post.author.handle,
            avatar: post.author.avatar,
          },
          text: post.record?.text || (post.embed ? '[Image or media - view on Bluesky]' : ''),
          likeCount: post.likeCount || 0,
          replyCount: post.replyCount || 0,
          repostCount: post.repostCount || 0,
          depth,
          url: `https://bsky.app/profile/${post.author.handle}/post/${post.uri.split('/').pop()}`,
        });

        if (reply.replies && Array.isArray(reply.replies)) {
          reply.replies.forEach(child => traverse(child, depth + 1));
        }
      }

      if (Array.isArray(thread.thread.replies)) {
        thread.thread.replies.forEach(reply => traverse(reply, 0));
      }

      return comments;
    }

    function formatRelativeTime(timestamp) {
      const now = Date.now();
      const then = new Date(timestamp).getTime();
      const diff = now - then;

      const minute = 60 * 1000;
      const hour = 60 * minute;
      const day = 24 * hour;

      if (diff < minute) return 'just now';
      if (diff < hour) return `${Math.floor(diff / minute)}m ago`;
      if (diff < day) return `${Math.floor(diff / hour)}h ago`;
      return `${Math.floor(diff / day)}d ago`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function checkForNewComments() {
      try {
        const uri = extractPostUri(threadUrl);
        if (!uri) return;

        const response = await fetch(`${BLUESKY_API}?uri=${encodeURIComponent(uri)}&depth=10`);
        if (!response.ok) {
          console.warn('Could not fetch fresh comments (API unavailable)');
          return; // Graceful degradation - cached comments still visible
        }

        const data = await response.json();
        const freshComments = parseComments(data);

        // Get timestamps of existing (cached) comments
        const existingTimestamps = new Set(
          Array.from(commentsList.querySelectorAll('.comment'))
            .map(el => el.dataset.timestamp)
        );

        // Find new comments (not in cache)
        const newComments = freshComments.filter(c =>
          !existingTimestamps.has(c.timestamp)
        );

        if (newComments.length > 0) {
          appendNewComments(newComments);
          updateCommentCount(freshComments.length);
        }
      } catch (error) {
        console.warn('Failed to check for new comments:', error);
        // Fail silently - cached comments are still visible
      }
    }

    function appendNewComments(comments) {
      comments.forEach(comment => {
        const article = document.createElement('article');
        article.className = 'comment comment-new';
        article.dataset.depth = comment.depth;
        article.dataset.timestamp = comment.timestamp;
        article.style.setProperty('--comment-depth', comment.depth);

        article.innerHTML = `
          <div class="new-badge">New</div>
          <header class="comment-header">
            <a href="https://bsky.app/profile/${escapeHtml(comment.author.handle)}"
               class="comment-author-link"
               target="_blank"
               rel="noopener noreferrer">
              <img src="${escapeHtml(comment.author.avatar)}"
                   alt=""
                   class="comment-avatar"
                   width="48"
                   height="48"
                   loading="lazy">
              <div class="comment-author">
                <strong class="comment-author-name">${escapeHtml(comment.author.displayName)}</strong>
                <span class="comment-author-handle">@${escapeHtml(comment.author.handle)}</span>
              </div>
            </a>
            <a href="${escapeHtml(comment.url)}"
               class="comment-timestamp"
               target="_blank"
               rel="noopener noreferrer"
               title="${comment.timestamp}">
              <time datetime="${comment.timestamp}">${formatRelativeTime(comment.timestamp)}</time>
            </a>
          </header>
          <div class="comment-body">
            <p class="comment-text">${escapeHtml(comment.text)}</p>
          </div>
          <footer class="comment-footer">
            <div class="comment-stats">
              ${comment.likeCount > 0 ? `<span class="stat"><span class="stat-icon">‚ù§Ô∏è</span> ${comment.likeCount}</span>` : ''}
              ${comment.replyCount > 0 ? `<span class="stat"><span class="stat-icon">üí¨</span> ${comment.replyCount}</span>` : ''}
              ${comment.repostCount > 0 ? `<span class="stat"><span class="stat-icon">üîÑ</span> ${comment.repostCount}</span>` : ''}
            </div>
            <a href="${escapeHtml(comment.url)}" class="comment-reply-link" target="_blank" rel="noopener noreferrer">Reply</a>
          </footer>
        `;

        commentsList.appendChild(article);
      });

      // Show notification
      const notification = document.createElement('div');
      notification.className = 'new-comments-notification';
      notification.textContent = `${comments.length} new ${comments.length === 1 ? 'reply' : 'replies'}`;
      document.body.appendChild(notification);

      setTimeout(() => notification.classList.add('show'), 10);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    function updateCommentCount(totalCount) {
      const countElement = document.querySelector('.comment-count');
      if (countElement) {
        countElement.innerHTML = `${totalCount} ${totalCount === 1 ? 'reply' : 'replies'} on
          <a href="${threadUrl}" class="bluesky-link" target="_blank" rel="noopener noreferrer">Bluesky</a>`;
      }
    }
  </script>
</section>


{% else %}
{# No Bluesky thread set #}
<section class="bluesky-comments no-thread" data-pagefind-ignore>
  <h2 class="comments-heading">Discussion</h2>
  <p class="no-thread-message">
    This post hasn't been shared on Bluesky yet.
    <a href="https://bsky.app/intent/compose?text={{ title | urlencode }}%20{{ canonicalUrl | urlencode }}"
       target="_blank"
       rel="noopener noreferrer">
      Start the conversation ‚Üí
    </a>
  </p>

</section>
{% endif %}
