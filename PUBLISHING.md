# Publishing Workflow

Multi-step workflow with preview and confirmation at each stage to prevent accidental publication.

## Quick Start

### From Command Line

```bash
# Interactive mode - select from list of drafts
npm run publish

# Direct mode - specify post slug
npm run publish:post <slug>
```

### From Front Matter CMS (VSCodium)

1. Open the post you want to publish
2. Click the Front Matter icon in the sidebar
3. Under "Custom Actions" click **"ðŸ“¤ Publish Post (Full Workflow)"**
4. Follow the prompts in the integrated terminal

## Workflow Steps

The publishing workflow has **4 preview-and-confirm steps** before anything goes live:

### Step 1: Web Preview

- Shows URL: `http://localhost:8080/<slug>/`
- Confirm the web version looks correct
- If not, exit and make edits

### Step 2: Email Preview

- Shows URL: `http://localhost:8080/emails/<slug>/`
- Verify margin notes are converted to endnotes
- Confirm formatting looks good for email
- If not, exit and make edits

### Step 3: Bluesky Preview

- Shows suggested post text and URL
- Displays what the OG card will look like
- Confirm you're ready to post to Bluesky
- If not, exit and come back later

### Step 4: Final Confirmation

Shows what will happen:
- âœ“ Set `draft: false` in frontmatter
- âœ“ Rebuild the site
- âœ“ Prompt you to post to Bluesky
- âœ“ Ask if you want to send email to Buttondown

**This is your last chance to back out!**

### Publishing Actions

If you confirm Step 4, the script will:

1. **Update frontmatter** - Sets `draft: false` and `publish: true`
2. **Rebuild site** - Runs `npm run build`
3. **Bluesky posting** - Prompts you to post, then asks for the thread URL
4. **Save Bluesky URL** - Adds `bluesky_thread` to frontmatter
5. **Optional email** - Ask if you want to send to Buttondown subscribers

## Safety Features

### Multiple Confirmations
Every step requires explicit confirmation. You can exit at any point.

### No Accidental Sends
- Buttondown only sends if you explicitly confirm
- Posts marked with `buttondown_sent: true` won't send again
- Email preview must be checked before sending

### Rollback Friendly
If something goes wrong:
- Frontmatter changes are in git
- Can manually set `draft: true` to unpublish
- Buttondown tracking prevents duplicate sends

## Individual Actions

If you need to do steps separately:

### Preview Only

```bash
# Web version
open http://localhost:8080/<slug>/

# Email version  
open http://localhost:8080/emails/<slug>/
```

Or use Front Matter CMS actions:
- **"ðŸ‘€ Preview Web Version"** - Opens web preview
- **"ðŸ“§ Preview Email Version"** - Opens email preview

### Send to Buttondown Only

```bash
# Dry run (shows what would be sent)
npm run buttondown:send:dry <slug>

# Actually send
npm run buttondown:send <slug>
```

Or use Front Matter CMS action:
- **"ðŸ“¬ Send to Buttondown"** - Sends email immediately

### List Pending Posts

```bash
npm run buttondown:list
```

Shows all posts with `publish: true` that haven't been sent yet.

## Frontmatter Fields

### Required Before Publishing

```yaml
title: "Post Title"
date: 2026-01-06
draft: false  # or publish: true
```

### Optional But Recommended

```yaml
# For better social sharing
og_description: "Hook for social media (different from RSS description)"
post_image: "/slug/assets/image.jpg"
post_image_alt: "Alt text for the image"

# For SEO and RSS
description: "Longer description for RSS feeds and search engines"
```

### Auto-Generated by Publishing Script

```yaml
# After Bluesky posting
bluesky_thread: "https://bsky.app/profile/username/post/abc123"

# After Buttondown send
buttondown_sent: true
buttondown_sent_date: 2026-01-06T10:30:00.000Z
buttondown_email_id: "abc123..."
```

## Environment Setup

### Required for Buttondown

```bash
export BUTTONDOWN_API_KEY="your-api-key-here"
```

Add to your `~/.zshrc` or `~/.bashrc`:

```bash
# Buttondown
export BUTTONDOWN_API_KEY="btndwn_xxx..."
```

Get your API key from: https://buttondown.com/settings/api

## Troubleshooting

### "Post not found"
- Check the slug matches the directory name in `content/blog/`
- Make sure `index.md` exists in the post directory

### "Could not parse frontmatter"
- Frontmatter must start and end with `---`
- YAML syntax must be valid
- Check for missing colons or incorrect indentation

### Email preview shows margin notes
- Run `npm run build` to regenerate email variants
- Check that `_site/emails/<slug>/index.html` exists

### Buttondown says "already sent"
- Post has `buttondown_sent: true` in frontmatter
- Use `--force` flag to send anyway (dangerous!)
- Or manually remove the field from frontmatter

### Can't post to Bluesky
- Workflow doesn't post automatically
- You post manually, then paste the URL back
- This gives you full control over the Bluesky post text

## Tips

### Test First
Always test with a draft post first to learn the workflow.

### Keep Dev Server Running
The workflow expects `npm start` to be running for previews.

### Check Email Twice
Email is harder to fix after sending. Take your time with the email preview.

### Don't Rush Bluesky
You can exit at Step 3, post to Bluesky manually later, then run the workflow again.

### Save Bluesky URLs
Even if you skip Buttondown, run the workflow to save the Bluesky URL to frontmatter.

---

Last updated: 2026-01-06
